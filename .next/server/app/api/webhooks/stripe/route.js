"use strict";(()=>{var e={};e.id=798,e.ids=[798],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3263:e=>{e.exports=import("firebase-admin/app")},79637:e=>{e.exports=import("firebase-admin/auth")},72929:e=>{e.exports=import("firebase-admin/firestore")},32081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},73837:e=>{e.exports=require("util")},76540:(e,t,i)=>{i.a(e,async(e,r)=>{try{i.r(t),i.d(t,{headerHooks:()=>u,originalPathname:()=>m,requestAsyncStorage:()=>p,routeModule:()=>c,serverHooks:()=>l,staticGenerationAsyncStorage:()=>d,staticGenerationBailout:()=>_});var o=i(10884),a=i(16132),s=i(96119),n=e([s]);s=(n.then?(await n)():n)[0];let c=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/webhooks/stripe/route",pathname:"/api/webhooks/stripe",filename:"route",bundlePath:"app/api/webhooks/stripe/route"},resolvedPagePath:"D:\\Veliora Techworks\\2.SaaSFlow_Subscription_and_Billing_Platform\\app\\api\\webhooks\\stripe\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:p,staticGenerationAsyncStorage:d,serverHooks:l,headerHooks:u,staticGenerationBailout:_}=c,m="/api/webhooks/stripe/route";r()}catch(e){r(e)}})},96119:(e,t,i)=>{i.a(e,async(e,r)=>{try{i.r(t),i.d(t,{POST:()=>POST,runtime:()=>c});var o=i(95798),a=i(31803),s=i(64980),n=e([s]);s=(n.then?(await n)():n)[0];let c="nodejs",p=process.env.STRIPE_WEBHOOK_SECRET;async function POST(e){let t;if(!s.iW)return console.error("Firebase Admin SDK not configured. Webhook processing skipped."),o.Z.json({error:"Server configuration error"},{status:500});let i=await e.text(),r=e.headers.get("stripe-signature");try{t=a.Ag.webhooks.constructEvent(i,r,p)}catch(e){return console.error("Webhook signature verification failed:",e),o.Z.json({error:"Invalid signature"},{status:400})}try{switch(t.type){case"customer.subscription.created":case"customer.subscription.updated":{let e=t.data.object,i=e.customer,r=await s.iW.collection("users").where("stripeCustomerId","==",i).get();if(!r.empty){let i=r.docs[0],o=i.id;await s.iW.collection("users").doc(o).update({subscriptionStatus:e.status,subscriptionId:e.id,currentPeriodEnd:new Date(1e3*e.current_period_end),planId:e.items.data[0].price.id}),await s.iW.collection("activity_logs").add({userId:o,action:t.type,timestamp:new Date,metadata:{subscriptionId:e.id,status:e.status}})}break}case"customer.subscription.deleted":{let e=t.data.object,i=e.customer,r=await s.iW.collection("users").where("stripeCustomerId","==",i).get();if(!r.empty){let t=r.docs[0],i=t.id;await s.iW.collection("users").doc(i).update({subscriptionStatus:"canceled",subscriptionId:null,currentPeriodEnd:null,planId:null}),await s.iW.collection("activity_logs").add({userId:i,action:"subscription.canceled",timestamp:new Date,metadata:{subscriptionId:e.id}})}break}case"invoice.paid":{let e=t.data.object,i=e.customer,r=await s.iW.collection("users").where("stripeCustomerId","==",i).get();if(!r.empty){let t=r.docs[0],i=t.id;await s.iW.collection("invoices").add({userId:i,invoiceId:e.id,amount:e.amount_paid,currency:e.currency,status:"paid",paidAt:new Date(1e3*e.status_transitions.paid_at),periodStart:new Date(1e3*e.period_start),periodEnd:new Date(1e3*e.period_end)})}break}case"invoice.payment_failed":{let e=t.data.object,i=e.customer,r=await s.iW.collection("users").where("stripeCustomerId","==",i).get();if(!r.empty){let t=r.docs[0],i=t.id;await s.iW.collection("activity_logs").add({userId:i,action:"payment.failed",timestamp:new Date,metadata:{invoiceId:e.id,amount:e.amount_due}})}break}default:console.log(`Unhandled event type: ${t.type}`)}return o.Z.json({received:!0})}catch(e){return console.error("Webhook handler error:",e),o.Z.json({error:"Webhook handler failed"},{status:500})}}r()}catch(e){r(e)}})},64980:(e,t,i)=>{i.a(e,async(e,r)=>{try{i.d(t,{iW:()=>d});var o=i(3263),a=i(79637),s=i(72929),n=e([o,a,s]);[o,a,s]=n.then?(await n)():n;let c=["FIREBASE_PROJECT_ID","FIREBASE_PRIVATE_KEY","FIREBASE_CLIENT_EMAIL"].filter(e=>!process.env[e]);c.length>0&&(console.warn(`Missing Firebase environment variables: ${c.join(", ")}`),console.warn("Firebase Admin SDK will not be initialized. Please check your .env.local file."));let p=null,d=null;if(0===c.length){let e={type:"service_account",project_id:process.env.FIREBASE_PROJECT_ID,private_key_id:process.env.FIREBASE_PRIVATE_KEY_ID,private_key:process.env.FIREBASE_PRIVATE_KEY?.replace(/\\n/g,"\n"),client_email:process.env.FIREBASE_CLIENT_EMAIL,client_id:process.env.FIREBASE_CLIENT_ID,auth_uri:"https://accounts.google.com/o/oauth2/auth",token_uri:"https://oauth2.googleapis.com/token",auth_provider_x509_cert_url:"https://www.googleapis.com/oauth2/v1/certs",client_x509_cert_url:`https://www.googleapis.com/robot/v1/metadata/x509/${process.env.FIREBASE_CLIENT_EMAIL}`};try{p=0===(0,o.getApps)().length?(0,o.initializeApp)({credential:(0,o.cert)(e)}):(0,o.getApps)()[0],(0,a.getAuth)(p),d=(0,s.getFirestore)(p)}catch(e){console.error("Failed to initialize Firebase Admin SDK:",e)}}r()}catch(e){r(e)}})},31803:(e,t,i)=>{i.d(t,{Ag:()=>o});var r=i(78888);let o=new r.Z(process.env.STRIPE_SECRET_KEY,{apiVersion:"2023-10-16"});process.env.STRIPE_STARTER_PRICE_ID,process.env.STRIPE_PRO_PRICE_ID}};var t=require("../../../../webpack-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),i=t.X(0,[535],()=>__webpack_exec__(76540));module.exports=i})();